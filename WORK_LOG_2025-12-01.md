# Work Log - December 1, 2025

**Date:** 2025-12-01  
**Database File:** `instance/app.db`  
**Project:** IPI Real Estate Investment Platform

---

## üìã Summary

Today we implemented two major features:
1. **Wallet Withdrawal Request System** - Users can now request withdrawals with admin approval
2. **Automatic Monthly Payout Scheduler** - Rental income is distributed automatically based on individual investment dates

---

## üéØ Feature 1: Wallet Withdrawal Request System

### Overview
Completely replaced manual deposit/withdrawal with a professional request-based system where users submit withdrawal requests and admins approve them with proof of transfer.

### What Was Removed
- ‚ùå Manual deposit functionality
- ‚ùå Direct withdrawal functionality

### What Was Added

#### Database Changes
**New Table: `withdrawal_requests`**
```sql
- id: Integer (Primary Key)
- user_id: Foreign Key to users
- amount: Float
- payment_method: String (instapay/wallet/company)
- account_details: String (phone/account number)
- status: String (pending/approved/rejected/cancelled)
- admin_notes: Text
- proof_image: String (filename)
- request_date: DateTime
- processed_date: DateTime
- processed_by: Foreign Key to admin user
```

#### User Features
1. **Submit Withdrawal Request** (`/user/withdrawal-request`)
   - Minimum amount: 100 EGP
   - Maximum: Current wallet balance
   - Payment methods:
     - üí≥ Instapay
     - üì± E-Wallet
     - üè¢ Company Pickup
   - One pending request limit per user
   - Account details required (except for company pickup)

2. **Cancel Pending Request** (`/user/cancel-withdrawal/<id>`)
   - Users can cancel their own pending requests

3. **View Request History**
   - See all past withdrawal requests
   - Track status (pending/approved/rejected)

#### Admin Features
1. **View All Requests** (`/admin/withdrawal-requests`)
   - Filter by status (all/pending/approved/rejected)
   - See pending count badge
   - List view with user info

2. **Request Details** (`/admin/withdrawal-request/<id>`)
   - Full user information
   - Current wallet balance
   - Payment method details

3. **Approve Request** (`/admin/withdrawal-request/<id>/approve`)
   - Upload proof of transfer (image/PDF)
   - Add optional notes
   - Automatically:
     - Deducts from user wallet
     - Creates transaction record
     - Updates request status

4. **Reject Request** (`/admin/withdrawal-request/<id>/reject`)
   - Mandatory rejection reason
   - User can see notes

### Files Modified
- `app/models.py` - Added WithdrawalRequest model
- `app/routes/user_views.py` - Added withdrawal request routes
- `app/routes/admin.py` - Added admin approval routes
- `app/templates/user/wallet.html` - Complete rebuild
- `app/templates/admin/withdrawal_requests.html` - NEW
- `app/templates/admin/withdrawal_request_detail.html` - NEW
- `app/templates/admin/dashboard.html` - Added navigation link

### Migration Script
- `create_withdrawal_table.py` - Creates withdrawal_requests table

---

## ü§ñ Feature 2: Automatic Monthly Payout Scheduler

### Overview
Implemented automatic monthly rental income distribution based on individual investment approval dates. Each investor is tracked separately and paid exactly 1 month after their approval date.

### How It Works
1. **Daily Scheduler** runs at **00:05 AM** (Cairo time)
2. Checks all approved investments
3. For each share:
   - Gets approval date from InvestmentRequest.date_reviewed
   - Calculates months elapsed
   - Checks last payout date
   - Distributes income for any unpaid months
4. Automatic wallet credit + transaction creation

### Example Timeline
```
User: Ibrahim
Investment Approved: Dec 1, 2025
Monthly Share: 600 EGP

Automatic Payouts:
- Jan 1, 2026 ‚Üí 600 EGP
- Feb 1, 2026 ‚Üí 600 EGP  
- Mar 1, 2026 ‚Üí 600 EGP
...and so on
```

### Database Changes
**Modified Tables:**
1. **shares table**
   - Added: `last_auto_payout_date` (DateTime)

2. **car_shares table**
   - Added: `last_auto_payout_date` (DateTime)

### Key Features
- ‚úÖ Individual tracking per investment
- ‚úÖ Prevents double-distribution
- ‚úÖ Works for both apartments and cars
- ‚úÖ Creates transaction records automatically
- ‚úÖ Calculates exact month differences
- ‚úÖ Manual "Distribute All" button still works

### Files Created/Modified
**NEW FILES:**
- `app/utils/__init__.py` - Utils package
- `app/utils/auto_payouts.py` - Payout calculation logic
- `migrate_add_payout_dates.py` - Database migration
- `test_auto_payouts.py` - Testing script
- `create_test_investment.py` - Test data generator

**MODIFIED FILES:**
- `app/__init__.py` - Registered scheduler task
- `app/models.py` - Added last_auto_payout_date fields

### Scheduler Configuration
```python
@scheduler.task('cron', id='automatic_monthly_payouts', hour=0, minute=5)
def scheduled_automatic_payouts():
    # Runs daily at 00:05 AM Cairo time
    # Distributes rental income automatically
```

### Testing Results
**Test Date:** Dec 1, 2025, 10:00 PM  
**Test User:** a@a.com  
**Test Investment:** 1 share from Nov 1, 2025 (1 month ago)  
**Expected Payout:** 600 EGP  
**Result:** ‚úÖ SUCCESS
- Scheduler ran at configured time
- Detected investment needing payout
- Calculated correct amount
- Wallet credited automatically
- Transaction record created

---

## üìä Database Schema Changes

### New Tables
1. **withdrawal_requests** (13 columns)

### Modified Tables
1. **shares** - Added `last_auto_payout_date`
2. **car_shares** - Added `last_auto_payout_date`

---

## üîß Configuration Files

### Scheduler Settings
**File:** `app/__init__.py`
```python
# Production schedule
hour=0, minute=5  # Runs at 00:05 AM daily

# For testing (used temporarily)
hour=22, minute=0  # Runs at 10:00 PM
```

### Database Location
**File:** `config.py`
```python
SQLALCHEMY_DATABASE_URI = 'sqlite:///app.db'
# Creates: instance/app.db
```

---

## üìù Important Notes

### Withdrawal Request System
1. **Minimum withdrawal:** 100 EGP
2. **One pending request limit** prevents abuse
3. **Proof required:** Admin must upload transfer proof
4. **Account details:** Optional for company pickup only
5. **Transaction creation:** Automatic on approval

### Automatic Payout System
1. **Runs daily** at 00:05 AM Cairo time
2. **Individual tracking:** Each investment tracked separately
3. **Approval date matters:** Uses InvestmentRequest.date_reviewed
4. **Double-distribution prevention:** via last_auto_payout_date
5. **Manual override:** Admin can still use "Distribute All"
6. **Calculation:** Uses relativedelta for accurate month math

### Testing Approach
1. Created test user: a@a.com
2. Created investment from 1 month ago
3. Changed scheduler to 10 PM for testing
4. Verified payout worked correctly
5. Reverted scheduler to 00:05 AM

---

## üöÄ Deployment Checklist

### Before Going Live
- [x] Database migrations applied
- [x] Scheduler configured for production (00:05 AM)
- [x] Withdrawal request system tested
- [x] Automatic payout system tested
- [x] Admin can upload proof images
- [x] Transaction records created correctly
- [x] Code pushed to GitHub

### Monitoring
- Check scheduler runs daily at 00:05 AM
- Monitor wallet balances for accuracy
- Review withdrawal request queue
- Check transaction logs

---

## üîó Quick Access

### User Routes
- `/user/wallet` - Wallet page with withdrawal requests
- `/user/withdrawal-request` - Submit withdrawal (POST)
- `/user/cancel-withdrawal/<id>` - Cancel request (POST)

### Admin Routes
- `/admin/withdrawal-requests` - List all requests
- `/admin/withdrawal-request/<id>` - View details
- `/admin/withdrawal-request/<id>/approve` - Approve (POST)
- `/admin/withdrawal-request/<id>/reject` - Reject (POST)

### Database File
- **Location:** `instance/app.db`
- **Full Path:** `/Users/ibrahimfakhry/Desktop/last/ipi/instance/app.db`

---

## üì¶ Git Commits (Today)

1. **feat: Implement withdrawal request system with admin approval**
   - Removed manual deposit/withdraw
   - Added withdrawal request workflow
   - Admin approval with proof upload

2. **feat: Implement automatic monthly payout scheduler**
   - Daily scheduler at 00:05 AM
   - Individual investment tracking
   - Auto wallet credit + transaction creation

3. **test: Verified automatic payout system works perfectly**
   - Created test investment
   - Tested scheduler
   - Confirmed wallet credit

---

## üí° Future Improvements (Optional)

1. **Email Notifications**
   - Notify users when withdrawal approved/rejected
   - Notify admins of new requests

2. **SMS Notifications**
   - Send confirmation SMS for large withdrawals

3. **Dashboard Analytics**
   - Show total withdrawals per month
   - Track approval rates

4. **Bulk Approval**
   - Admin can approve multiple requests at once

5. **Export Reports**
   - Monthly withdrawal reports
   - Payout distribution reports

---

## üë• Test Users

### Admin
- Email: `amsprog2022@gmail.com`
- Password: `Zo2lot@123`

### Test User
- Email: `a@a.com`
- Has 1 test investment
- Current wallet: 600 EGP (from auto-payout)

---

## üéØ Success Metrics

### Withdrawal System
- ‚úÖ Zero manual interventions needed
- ‚úÖ Full audit trail (request ‚Üí proof ‚Üí approval)
- ‚úÖ User-friendly interface
- ‚úÖ Admin controls maintained

### Automatic Payouts
- ‚úÖ 100% automation achieved
- ‚úÖ Zero double-payments
- ‚úÖ Accurate month calculations
- ‚úÖ Individual investor tracking
- ‚úÖ Manual override available

---

**End of Documentation - December 1, 2025**
