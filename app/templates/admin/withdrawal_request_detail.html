{% extends "base.html" %}

{% block title %}تفاصيل طلب السحب{% endblock %}

{% block content %}
<div class="container" style="padding: 3rem 0;">
    <div style="margin-bottom: 2rem;">
        <a href="{{ url_for('admin.withdrawal_requests') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-right"></i> العودة للقائمة
        </a>
    </div>

    <h1 style="margin-bottom: 2rem;">
        <i class="fas fa-file-alt"></i> تفاصيل طلب السحب #{{ withdrawal.id }}
    </h1>

    <!-- Request Details -->
    <div class="grid grid-2" style="margin-bottom: 2rem;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">معلومات الطلب</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <strong>المبلغ:</strong>
                        <span style="color: var(--gold); font-size: 1.5rem; font-weight: bold;">{{
                            "{:,.0f}".format(withdrawal.amount) }} جنيه</span>
                    </div>
                    <div>
                        <strong>طريقة الاستلام:</strong> {{ withdrawal.payment_method_arabic }}
                    </div>
                    <div>
                        <strong>تفاصيل الحساب:</strong> {{ withdrawal.account_details }}
                    </div>
                    <div>
                        <strong>الحالة:</strong>
                        <span
                            class="badge badge-{% if withdrawal.status == 'pending' %}warning{% elif withdrawal.status == 'approved' %}success{% elif withdrawal.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                            {{ withdrawal.status_arabic }}
                        </span>
                    </div>
                    <div>
                        <strong>تاريخ الطلب:</strong> {{ withdrawal.request_date.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                    {% if withdrawal.processed_date %}
                    <div>
                        <strong>تاريخ المعالجة:</strong> {{ withdrawal.processed_date.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">معلومات المستخدم</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <strong>ال اسم:</strong> {{ withdrawal.user.name }}
                    </div>
                    <div>
                        <strong>البريد الإلكتروني:</strong> {{ withdrawal.user.email }}
                    </div>
                    <div>
                        <strong>رصيد المحفظة الحالي:</strong>
                        <span style="color: var(--gold); font-weight: bold;">{{
                            "{:,.0f}".format(withdrawal.user.wallet_balance) }} جنيه</span>
                    </div>
                    <div>
                        <strong>رقم الإحالة:</strong> {{ withdrawal.user.referral_number }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Notes -->
    {% if withdrawal.admin_notes %}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3 class="card-title">ملاحظات الإدارة</h3>
        </div>
        <div class="card-body">
            <p style="white-space: pre-wrap;">{{ withdrawal.admin_notes }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Proof Image -->
    {% if withdrawal.proof_image %}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3 class="card-title">إثبات التحويل</h3>
        </div>
        <div class="card-body">
            <img src="{{ url_for('static', filename='uploads/withdrawal_proofs/' + withdrawal.proof_image) }}"
                alt="Proof" style="max-width: 100%; height: auto; border-radius: 8px;">
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    {% if withdrawal.status == 'pending' %}
    <div class="grid grid-2">
        <!-- Approve Form -->
        <div class="card">
            <div class="card-header" style="background: var(--success); color: white;">
                <h3 class="card-title"><i class="fas fa-check"></i> الموافقة على الطلب</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.approve_withdrawal', request_id=withdrawal.id) }}"
                    enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label">صورة إثبات التحويل (مطلوب)</label>
                        <input type="file" name="proof_image" class="form-control" accept="image/*,application/pdf"
                            required>
                        <small class="text-muted">صورة التحويل أو الإيصال</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ملاحظات (اختياري)</label>
                        <textarea name="admin_notes" class="form-control" rows="3"
                            placeholder="ملاحظات للمستخدم..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-success" style="width: 100%;"
                        onclick="return confirm('سيتم خصم {{ \" {:,.0f}\".format(withdrawal.amount) }} جنيه من محفظة
                        المستخدم. هل أنت متأكد؟')">
                        <i class="fas fa-check"></i> الموافقة وخصم المبلغ
                    </button>
                </form>
            </div>
        </div>

        <!-- Reject Form -->
        <div class="card">
            <div class="card-header" style="background: var(--danger); color: white;">
                <h3 class="card-title"><i class="fas fa-times"></i> رفض الطلب</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.reject_withdrawal', request_id=withdrawal.id) }}">
                    <div class="form-group">
                        <label class="form-label">سبب الرفض (مطلوب)</label>
                        <textarea name="admin_notes" class="form-control" rows="5" placeholder="أدخل سبب الرفض..."
                            required></textarea>
                    </div>

                    <button type="submit" class="btn btn-danger" style="width: 100%;"
                        onclick="return confirm('هل أنت متأكد من رفض هذا الطلب؟')">
                        <i class="fas fa-times"></i> رفض الطلب
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}