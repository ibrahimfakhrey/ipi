{% extends "base.html" %}

{% block title %}{{ apartment.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}">
{% endblock %}

{% block content %}
<div style="padding: 3rem 0;">
    <div class="container" style="max-width: 1000px;">
        <div class="grid grid-2" style="gap: 2rem;">
            <!-- Image -->

            <div>
                {% if apartment.images and apartment.images|length > 0 %}
                    <div class="apartment-gallery" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                        {% for img in apartment.images %}
                        <button class="gallery-thumb" data-src="{{ url_for('static', filename='images/apartments/' + img) }}" aria-label="عرض الصورة {{ loop.index }}" style="border:0; background:transparent; padding:0; cursor:pointer;">
                            <img src="{{ url_for('static', filename='images/apartments/' + img) }}"
                                 alt="{{ apartment.title }} صورة {{ loop.index }}"
                                 style="width:100%; height:140px; border-radius: 0.75rem; box-shadow: var(--shadow-lg); object-fit: cover; display:block;">
                        </button>
                        {% endfor %}
                    </div>

                    <!-- Lightbox modal -->
                    <div id="gallery-modal" class="gallery-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:9999;">
                        <button id="gallery-close" style="position:absolute; top:20px; right:20px; background:transparent; border:0; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
                        <button id="gallery-prev" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.4); border:0; color:#fff; padding:12px; border-radius:6px; cursor:pointer;">◀</button>
                        <img id="gallery-current" src="" alt="" style="max-width:90%; max-height:80%; border-radius:8px; box-shadow:0 12px 30px rgba(0,0,0,0.6);">
                        <button id="gallery-next" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.4); border:0; color:#fff; padding:12px; border-radius:6px; cursor:pointer;">▶</button>
                    </div>
                {% elif apartment.image and apartment.image != 'default_apartment.jpg' %}
                    <img src="{{ url_for('static', filename='images/apartments/' + apartment.image) }}" 
                         alt="{{ apartment.title }}"
                         style="width: 100%; border-radius: 1rem; box-shadow: var(--shadow-lg);">
                {% else %}
                    <div style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, var(--secondary-navy) 0%, var(--background-navy) 100%); border-radius: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-lg);">
                        <i class="fas fa-building" style="font-size: 5rem; color: var(--text-muted);"></i>
                    </div>
                {% endif %}
                
                <div class="card" style="margin-top: 1.5rem;">
                    <h3 class="text-gold" style="margin-bottom: 1rem;">معلومات الاستثمار</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>سعر الحصة الواحدة:</span>
                            <strong class="text-gold">{{ "{:,.0f}".format(apartment.share_price) }} جنيه</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>الحصص المتاحة:</span>
                            <strong>{{ apartment.shares_available }} / {{ apartment.total_shares }}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>الإيجار الشهري:</span>
                            <strong class="text-success">{{ "{:,.0f}".format(apartment.monthly_rent) }} جنيه</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>العائد الشهري لكل حصة:</span>
                            <strong class="text-success">{{ "{:,.0f}".format(apartment.monthly_rent / apartment.total_shares) }} جنيه</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>العائد السنوي المتوقع:</span>
                            <strong class="text-gold">{{ "%.1f"|format((apartment.monthly_rent * 12 / apartment.total_price) * 100) }}%</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>عدد المستثمرين:</span>
                            <strong>{{ investors_count }}</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Details -->
            <div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <h1 style="margin-bottom: 0;">{{ apartment.title }}</h1>
                    <span class="badge badge-{{ 'success' if apartment.status == 'جديد' else 'warning' if apartment.status == 'متاح' else 'danger' }}">
                        {{ apartment.status }}
                    </span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 2rem; color: var(--text-muted);">
                    <i class="fas fa-map-marker-alt"></i>
                    {{ apartment.location }}
                </div>
                
                <div class="card" style="margin-bottom: 2rem;">
                    <h2 class="text-gold" style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                        {{ "{:,.0f}".format(apartment.total_price) }} جنيه
                    </h2>
                    <p class="text-muted">السعر الإجمالي للعقار</p>
                    
                    <div class="progress-bar-container" style="margin: 1.5rem 0;">
                        <div class="progress-bar" data-percentage="{{ apartment.completion_percentage }}" style="width: 0%"></div>
                    </div>
                    <p class="text-center">تم بيع {{ apartment.completion_percentage|round(1) }}% من الحصص</p>
                </div>
                
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="text-gold">الوصف</h3>
                    <p style="line-height: 1.8; white-space: pre-wrap;">{{ apartment.description }}</p>
                </div>
                
                {% if current_user.is_authenticated and not current_user.is_admin and apartment.shares_available > 0 and not apartment.is_closed %}
                    <a href="{{ url_for('user_views.buy_shares', apartment_id=apartment.id) }}" 
                       class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-shopping-cart"></i> شراء حصص الآن
                    </a>
                {% elif not current_user.is_authenticated %}
                    <a href="{{ url_for('auth.login') }}" 
                       class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> سجل دخولك للاستثمار
                    </a>
                {% elif apartment.shares_available == 0 or apartment.is_closed %}
                    <button class="btn btn-secondary btn-lg" style="width: 100%;" disabled>
                        <i class="fas fa-lock"></i> تم بيع جميع الحصص
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
